<!DOCTYPE html>
<html>
<head>
	<title>Anonymous Message Board</title>
	<meta name="description" content="freeCodeCamp - Information Security and Quality Assurance Project: Anonymous Message Board">
	<link rel="icon" type="image/x-icon" href="/public/favicon.ico">
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/public/bootstrap.min.css">
	<link rel="stylesheet" href="/public/style.css">
</head>
<body>
	<div class="container">
		<div class="p-4 my-4 bg-light rounded-3">
			<div class="row">
				<div class="col">
					<header>
						<h1 id="boardTitle" class="text-center"></h1>
					</header>

					<div id="submitNewThread" class="mb-3">
						<h3>Submit a new thread:</h3>
						<form id="newThread" class="text-center" action="/api/" method="post">
							<textarea class="form-control mb-2" rows="8" cols="120" name="text" placeholder="Thread text..." required></textarea>
							<input class="form-control mb-2" type="text" name="delete_password" placeholder="Password to delete" required>
							<input class="btn btn-primary" type="submit" value="Submit">
						</form>
					</div>

					<div id="boardDisplay"></div>

					<hr>

					<div class="footer text-center">by <a href="https://www.freecodecamp.org" target="_blank">freeCodeCamp</a> (ISQA3) & <a href="https://www.freecodecamp.org/adam777" target="_blank">Adam</a> | <a href="https://github.com/Adam777Z/freecodecamp-project-message-board" target="_blank">GitHub</a></div>
				</div>
			</div>
		</div>
	</div>

	<script>
	document.addEventListener('DOMContentLoaded', (event) => {
		var currentBoard = window.location.pathname.slice(3).replace(/\/$/, '');
		var url = '/api/threads/' + currentBoard + '?limit=0';

		document.querySelector('#boardTitle').innerHTML = 'Welcome to <a href="/">/</a><a href="/b/' + currentBoard + '">b/' + currentBoard + '</a>';

		fetch(url, {
			'method': 'GET'
		})
		.then((response) => {
			if (response['ok']) {
				return response.json();
			} else {
				throw 'Error';
			}
		})
		.then((data) => {
			var boardThreads = [];

			//
			// THIS ARRAY SET UP IS FOR CODE READABILITIES AND TESTING!
			// THIS IS NOT WHAT IT WOULD LOOK LIKE TO GO LIVE
			//

			data.forEach(function(ele) {
				// console.log(ele); // Can I use TypeScript please?!
				var thread = [];

				thread.push(
					'<div class="card thread mb-2">',
						'<h5 class="card-header">' + ele['text'] + '</h5>',
						'<div class="card-body">',
							'<div class="replies">'
				);

				var hiddenCount = ele['replycount'] - 3;
				if (hiddenCount < 1) {
					hiddenCount = 0;
				}

				thread.push('<p class="card-text">' + ele['replycount'] + ' replies total (' + hiddenCount + ' hidden) - <a href="/b/' + currentBoard + '/' + ele['_id'] + '">See the full thread here</a>.</p>');

				ele['replies'].forEach(function(rep) {
					thread.push(
								'<div class="card reply mb-2">',
									'<div class="card-body">',
										'<p class="card-text">' + rep['text'] + '</p>',
									'</div>',
									'<div class="card-footer text-muted">',
										'<div class="row align-items-center">',
											'<div class="col">',
												'<p class="mb-2"><span class="fw-semibold">Created on:</span> <span>' + rep['created_on'] + '</span></p>',
												'<p class="id m-0"><span class="fw-semibold">Reply ID:</span> <span>' + rep['_id'] + '</span></p>',
											'</div>',
											'<div class="col d-flex justify-content-end">',
												'<form class="reportReply me-4">',
													'<input type="hidden" name="thread_id" value="' + ele['_id'] + '">',
													'<input type="hidden" name="reply_id" value="' + rep['_id'] + '">',
													'<input class="btn btn-warning" type="submit" value="Report reply">',
												'</form>',
												'<form class="deleteReply d-flex">',
													'<input type="hidden" name="thread_id" value="' + ele['_id'] + '" required>',
													'<input type="hidden" name="reply_id" value="' + rep['_id'] + '" required>',
													'<input class="form-control me-2" type="text" name="delete_password" placeholder="Password" required>',
													'<input class="btn btn-danger" type="submit" value="Delete reply">',
												'</form>',
											'</div>',
										'</div>',
									'</div>',
								'</div>'
					);
				});

				thread.push(
								'<div class="newReply mt-3">',
									'<form id="newReply" class="text-center" action="/api/replies/' + currentBoard + '/" method="post">',
										'<input type="hidden" name="thread_id" value="' + ele['_id'] + '">',
										'<textarea class="form-control mb-2" rows="5" cols="80" name="text" placeholder="Quick reply..." required></textarea>',
										'<input class="form-control mb-2" type="text" name="delete_password" placeholder="Password to delete" required>',
										'<input class="btn btn-primary" type="submit" value="Submit">',
									'</form>',
								'</div>',
							'</div>',
						'</div>',
						'<div class="card-footer text-muted">',
							'<div class="row align-items-center">',
								'<div class="col">',
									'<p class="mb-2"><span class="fw-semibold">Created on:</span> <span>' + ele['created_on'] + '</span></p>',
									'<p class="m-0"><span class="fw-semibold">Thread ID:</span> <span>' + ele['_id'] + '</span></p>',
								'</div>',
								'<div class="col d-flex justify-content-end">',
									'<form class="reportThread me-4">',
										'<input type="hidden" name="thread_id" value="' + ele['_id'] + '">',
										'<input class="btn btn-warning" type="submit" value="Report thread">',
									'</form>',
									'<form class="deleteThread d-flex">',
										'<input type="hidden" name="thread_id" value="' + ele['_id'] + '" required>',
										'<input class="form-control me-2" type="text" name="delete_password" placeholder="Password" required>',
										'<input class="btn btn-danger" type="submit" value="Delete thread">',
									'</form>',
								'</div>',
							'</div>',
						'</div>',
					'</div>'
				);

				boardThreads.push(thread.join(''));
			});

			document.querySelector('#boardDisplay').innerHTML = boardThreads.join('');
		})
		.catch((error) => {
			console.log(error);
		});

		document.querySelector('#newThread').addEventListener('submit', (event2) => {
			event2.target.setAttribute('action', '/api/threads/' + currentBoard);
		});

		document.querySelector('#boardDisplay').addEventListener('submit', (event2) => {
			if (event2.target.classList.contains('reportReply')) {
				event2.preventDefault();

				let url = '/api/replies/' + currentBoard;

				fetch(url, {
					'method': 'PUT',
					'body': new URLSearchParams(new FormData(event2.target))
				})
				.then((response) => {
					if (response['ok']) {
						return response.text();
					} else {
						throw 'Error';
					}
				})
				.then((data) => {
					try {
						data = JSON.parse(data);
					} catch (error) {
						// console.log(error);
					}

					if (data['error'] !== undefined) {
						data = data['error'];
					}

					alert(data);
				})
				.catch((error) => {
					console.log(error);
				});
			}

			if (event2.target.classList.contains('deleteReply')) {
				event2.preventDefault();

				let url = '/api/replies/' + currentBoard;

				fetch(url, {
					'method': 'DELETE',
					'body': new URLSearchParams(new FormData(event2.target))
				})
				.then((response) => {
					if (response['ok']) {
						return response.text();
					} else {
						throw 'Error';
					}
				})
				.then((data) => {
					try {
						data = JSON.parse(data);
					} catch (error) {
						// console.log(error);
					}

					if (data['error'] !== undefined) {
						data = data['error'];
					}

					alert(data);
				})
				.catch((error) => {
					console.log(error);
				});
			}

			if (event2.target.classList.contains('reportThread')) {
				event2.preventDefault();

				let url = '/api/threads/' + currentBoard;

				fetch(url, {
					'method': 'PUT',
					'body': new URLSearchParams(new FormData(event2.target))
				})
				.then((response) => {
					if (response['ok']) {
						return response.text();
					} else {
						throw 'Error';
					}
				})
				.then((data) => {
					try {
						data = JSON.parse(data);
					} catch (error) {
						// console.log(error);
					}

					if (data['error'] !== undefined) {
						data = data['error'];
					}

					alert(data);
				})
				.catch((error) => {
					console.log(error);
				});
			}

			if (event2.target.classList.contains('deleteThread')) {
				event2.preventDefault();

				let url = '/api/threads/' + currentBoard;

				fetch(url, {
					'method': 'DELETE',
					'body': new URLSearchParams(new FormData(event2.target))
				})
				.then((response) => {
					if (response['ok']) {
						return response.text();
					} else {
						throw 'Error';
					}
				})
				.then((data) => {
					try {
						data = JSON.parse(data);
					} catch (error) {
						// console.log(error);
					}

					if (data['error'] !== undefined) {
						data = data['error'];
					}

					alert(data);
				})
				.catch((error) => {
					console.log(error);
				});
			}
		});
	});
	</script>
</body>
</html>